<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta http-equiv="Content-Type"  content="text/html; charset=utf-8">
    <title>Lab 3: Network Sniffing</title>
    <link rel="stylesheet" href="../labs.css" type="text/css">
</head>

<body>
<h1>Lab 3: Network Sniffing</h1>
<hr />

<h2>Overview</h2>
<p>
    <span class="todo">
        introduce
    </span>
</p>
<p>
    In this lab, you will be required to complete .
    You need to implement four specific functions: packet sniffing,
    packet analysis, packet spoofing, and design your own link
    layer protocol and using it to communicate with another machine.
</p>

<h3>Hand-in Procedure</h3>
<p>
    When you finished the lab, zip you code files with file
    name <samp>ID-lab-3.zip</samp>
    (e.g., <samp>SA19225111-lab-3.zip</samp>),
    and submit it to
    <a href="https://bb.ustc.edu.cn/">Online Teaching Platform</a>.
    The deadline is TBA (Beijing time).
    Any late submission will <b>NOT</b> be accepted.
</p>


<hr />

<h2>Part A: Web Server</h2>


<h3>1. Time Server</h3>
<span class="todo">
    todo
</span>




<h3>2. Web Server</h3>
<span class="todo">
    todo
</span>


<hr>
<h2>Part B: ICMP Tunneling</h2>

<h3>1. Raw Socket</h3>
<p>
    With raw sockets, we can capture all IP packets sent to the
    local machine (including IP headers and TCP/UDP/ICMP headers)
    and all frames received by the local machine (including data
    link layer protocol headers). A common socket cannot process
    network packets such as ICMP and IGMP, but SOCK_RAW can. With
    raw sockets, we can construct our own IP headers.
</p>
<p>
    Other sockets like stream sockets and data gram sockets receive
    data from the transport layer that contains no headers but only
    the payload. This means that there is no information about the
    source IP address and MAC address. If applications running on
    the same machine or on different machines are communicating,
    then they are only exchanging data.
</p>
<p>
    The purpose of a raw socket is absolutely different. A raw
    socket allows an application to directly access lower level
    protocols, which means a raw socket receives un-extracted
    packets(the process is as following graph). There is no need
    to provide the port and IP address to a raw socket, unlike
    in the case of stream and datagram sockets.
</p>

<img src="Lab2%20mini-Wireshark.assets/Figure-24.jpg" width="500" alt=""/>
<p>
    In this experiment, we need to obtain all types of packets
    from the MAC layer, so when constructing the socket, the
    first parameter is selected as <samp>AF_PACKET</samp>,
    indicating that the data to be obtained starts from the
    data link layer. The construction format is as follows:
</p>
<pre>
    int sock = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL))ï¼›
</pre>
<p>
    You should search more information by yourself to learn
    the usage of different parameters of socket function above.
    for example : https://zhuanlan.zhihu.com/p/59327439.
</p>

<h3>2. ICMP Tunnel</h3>
<span class="todo">
    todo
</span>




<hr>
<h2>Part C: Network Sniffing</h2>

<h3>1. Promiscuous Mode</h3>
<p>
    The device is connected to the network through a network
    interface card (NIC). A NIC is a physical or logical connection
    between a computer and the network. Each NIC has a hardware
    address, which is called a MAC address. When the NIC receives
    a packet from the network, it copies the packet to the memory
    of NIC, and checks the destination address in the header of
    the data frame. If the destination address matches the MAC
    address of the NIC, the data frame is copied to the kernel
    cache, and the NIC then interrupts to tell the CPU to
    finish processing the data.
</p>
<p>
    Because the NIC discards packets that do not match its MAC
    address, the sniffer cannot obtain these frames. Fortunately,
    most network cards have a special mode called
    <a href="https://en.wikipedia.org/wiki/Promiscuous_mode">
        promiscuous mode</a>. In this mode, the NIC passes
    each data frame it receives from the network to the kernel,
    regardless of whether the address matches.
</p>
<p>
    In this experiment, we need to open the promiscuous mode
    of the local network card in the following way to obtain
    all data packets.
</p>
<pre>
    struct packet_mreq mr;

    // Turn on the promiscuous mode
    mr.mr_type = PACKET_MR_PROMISC;
    setsockopt(sock, SOL_PACKET, PACKET_ADD_MEMBERSHIP, &mr, sizeof(mr));
</pre>

<p>
    Download the <a href="./src.zip">source code</a> and unzip.
    This source code is incomplete, you need to fill in the
    correct code blocks so that the function can work correctly.
</p>
<p>
    In this experiment, <samp>main.c</samp> is supplemented to
    realize the sniffing function of network packets, we've already
    shown some of the code. Use the raw socket to complete the
    packet sniffing function.
</p>
<p>
    The result is as follows:
</p>
<img src="Lab2%20mini-Wireshark.assets/image-20211008185057440.png" width="500" alt=""/>
<div class="question">
    <b>Exercise 1:</b>
    Complete the code above to make sure your
    function works correctly as required. You need to
    submit your source code.
</div>

<h3>
    3. Network Sniffing
</h3>
<p>
    In this part, you need to analyze the structure of
    ARP, ICMP, TCP, and UDP packets and print detailed information
    of them. Refer to the ICMP analysis function given in
    <samp>PacketProcess.h</samp> and <samp>packetProcess.c</samp>
    to complete the analysis function of the remaining three packets.
</p>
<p>
    Run ICMP analysis function, the result is as follows:
</p>
<img src="Lab2%20mini-Wireshark.assets/image-20211008190726961.png" width="700" alt=""/>
<div class="question">
    <b>Exercise 2:</b> Complete the code of Step 1 correctly,
    and submit your source code.
</div>
<b>Packet filter</b>
<p>
    When doing network sniffing, sniffers are often only
    interested in certain types of packets, such as TCP packets
    or DNS query packets. Therefore, after the packet is captured
    by the MAC layer, you need to implement filtering functions
    to filter out some uninteresting packets.
</p>
<p>
    Check the <samp>filter.h</samp> file for details of the
    function declarations. Refer to the given function
    <samp>filterByIpAddress()</samp> and complete filter by
    MAC address, protocol type, and port number. Run your
    program to check if it works correctly.
</p>
<div class="question">
    <b>Exercise 3:</b>
    Complete the code of Step 2 to make sure your
    function works correctly as required. Submit your source code.
</div>

<h2>Part D. Packet Spoofing</h2>
<p>
    In this experiment, you need to use two virtual machines,
    Host A and Host B. Host A is used to send the forged packet
    and host B is used to receive the packet.
</p>
<p>
    We have given a program for forging UDP datagrams. Run this
    program on host A and use Wireshark to capture packets on host B.
    The specific information of captured data packets is shown as follows:
</p>
<img src="Lab2%20mini-Wireshark.assets/udp1.png" width="750" alt=""/>
<p>
    Refer to this program to complete the forgery of TCP, ARP,
    and ICMP packets. According to programming specifications,
    You need to write implementations of these three types of
    protocol forgeries into one engineering project (such as
    ForgeProject) rather than three independently running
    programs. In your project, there is only one main function,
    The specific functions of TCP, ARP, and ICMP should appear
    in header files.
</p>
<h3>
    1 TCP packet forgery
</h3>
<p>
    Forge a SYN packet on host A and send it to host B for
    establishing a TCP connection. If you use the Wireshark to
    capture packets on host B, you can capture the SYN packet
    and the reply packet sent by host B. As shown below:
</p>
<img src="Lab2%20mini-Wireshark.assets/image-20211008195111778.png" width="800" alt=""/>
<p>
    You can view and analyze the details about this two
    data packets in the Wireshark.
</p>
<div class="question">
    <b>Exercise 4:</b>
    Write TCP_forge.h and TCP_forge.c in your
    project to achieve the forgery of TCP protocol packets.
</div>

<h3>
    2 ARP packet forgery
</h3>
<p>
    Forge an ARP packet on host A to request the MAC address
    of host B. After using the Wireshark to capture packets
    on host B, you can capture the ARP packet and host B's
    reply packet. As shown below:
</p>
<img src="Lab2%20mini-Wireshark.assets/arp1.PNG" width="880" alt=""/>
<p>
    You can view and analyze the details about this two
    data packets in the Wireshark.
</p>
<div class="question">
    <b>Exercise 5:</b>
    Write ARP_forge.h and ARP_forge.c in your
    project to achieve the forgery of ARP protocol packets.
</div>

<h3>
    3 ICMP packet forgery
</h3>
<p>
    On host A, forge an ICMP Echo(Ping) Request packet which
    destination IP address is host B. After the preceding code is run,
    the request packet and the ICMP Echo(Ping) Reply packet from
    host B are captured on host B. As shown below:
</p>
<img src="Lab2%20mini-Wireshark.assets/image-20211008202305979.png" width="700" alt=""/>
<p>
    You can view and analyze the details about this two
    data packets in the Wireshark.
</p>
<div class="question">
    <b>Exercise 6:</b>
    Write ICMP_forge.h and ICMP_forge.c in your
    project to achieve the forgery of ICMP protocol packets.
    You need to submit your source code.
</div>
<br>
<h3>5. Customized MAC Layer Protocol</h3>
<p>
    In this part, you need to design a new link layer
    communication protocol to achieve a two-way communication
    between two hosts.
</p>
<p>
    You need to implement the program as shown below:
</p>
<pre>
    Machine A send    : hello!
    Machine B receive : hello!
    Machine B send    : a message from B
    Machine A receive : a message from B
</pre>
<div class="challenge">
    <i>Challenge:</i> Design your own MAC layer protocol and use
    it to communicate
    between two hosts. To simplify this question, let's assume that
    the two sides of the communication take turns sending messages.
    Submit your source code.
</div>

<br>
<hr>
This completes this lab. Remember to zip you
code with file
name <samp>ID-lab-3.zip</samp> (e.g.,
<samp>SA19225789-lab-3.zip</samp>), and
submit it to <a href="https://bb.ustc.edu.cn/">Online Teaching
    Platform</a>.

<p>
    Happy hacking!
</p>

<br>
<br>



</body>

</html>









